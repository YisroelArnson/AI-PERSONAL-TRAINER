# Preferences Classification - Clarification

## Database Schema

```sql
create table public.preferences (
  id bigint generated by default as identity not null,
  user_id uuid null,
  type text not null,  -- This field is NOT used for temporary/permanent classification
  description text not null,
  user_transcription text null,
  recommendations_guidance text null,
  expire_time timestamp with time zone null,
  delete_after_call boolean null default false,
  created_at timestamp with time zone not null default now(),
  constraint preferences_pkey primary key (id),
  constraint preferences_user_id_fkey foreign key (user_id) references auth.users (id)
);
```

## How Preferences Are Classified

### Temporary Preferences
A preference is considered **TEMPORARY** if:
- `expire_time` is NOT NULL (has an expiration date/time), OR
- `delete_after_call` is TRUE (one-time use)

**Characteristics:**
- Override all other goals and constraints
- Session-specific or time-limited
- Automatically cleaned up after expiration or use
- Examples:
  - "Focus on upper body only today" (delete_after_call=true)
  - "Avoid cardio for the next week" (expire_time set to 7 days from now)
  - "No legs today" (delete_after_call=true)

### Permanent Preferences
A preference is considered **PERMANENT** if:
- `expire_time` is NULL (no expiration), AND
- `delete_after_call` is FALSE or NULL (persistent)

**Characteristics:**
- Always apply to recommendations
- Long-term restrictions or preferences
- Remain in database until explicitly deleted by user
- Examples:
  - "Avoid exercises that strain lower back" (medical restriction)
  - "Prefer compound movements over isolation exercises"
  - "No olympic lifts" (skill/safety preference)

## Implementation

### In `fetchUserData.service.js`
```javascript
// Separate permanent and temporary preferences for better AI context
// Temporary: has expire_time OR delete_after_call is true
// Permanent: no expire_time AND delete_after_call is false (or null)
const temporary = processedPreferences.filter(p => 
    p.expire_time !== null || p.delete_after_call === true
);
const permanent = processedPreferences.filter(p => 
    p.expire_time === null && p.delete_after_call !== true
);
```

### In `recommend.service.js` (Natural Language Formatter)
```javascript
// Temporary preferences shown with expiration info
TEMPORARY PREFERENCES (override all other goals - will expire or be deleted):
  - No lower body exercises today [one-time use]
  - Focus on chest and back only [expires: in 2 days]

// Permanent preferences shown without expiration
PERMANENT PREFERENCES (always apply):
  - Avoid exercises that strain lower back
  - Prefer compound movements over isolation
```

## AI Decision Hierarchy

The AI follows this priority order (highest to lowest):

1. **TEMPORARY PREFERENCES** - Override everything else
   - Has expire_time or delete_after_call=true
   - Current session or time-limited needs

2. **EXPLICIT REQUESTS** - Any specific request in current interaction
   - From requestData.explicitPreferences field

3. **PERMANENT PREFERENCES** - Long-term restrictions
   - No expire_time and delete_after_call=false/null
   - Always respected but can be overridden by temporary preferences

4. **GOALS & MUSCLES** - Priority based on weights
   - Higher weight = higher priority

5. **WORKOUT HISTORY** - For progression and variety
   - Used to inform load/rep recommendations
   - Helps avoid repetitive exercises

## Example Scenarios

### Scenario 1: User with Lower Back Issue
```javascript
// Permanent preference (always applies)
{
  description: "Avoid lower back strain",
  recommendations_guidance: "Avoid deadlifts, good mornings, and heavy squats",
  expire_time: null,
  delete_after_call: false
}

// Result: AI will never recommend these exercises
```

### Scenario 2: User Wants Upper Body Only Today
```javascript
// Temporary preference (one-time override)
{
  description: "Upper body only today",
  recommendations_guidance: "Focus exclusively on chest, back, shoulders, and arms",
  expire_time: null,
  delete_after_call: true  // Will be deleted after this recommendation call
}

// Result: AI ignores leg goals even if legs have high weight (0.9)
// After recommendation is generated, this preference is deleted
```

### Scenario 3: User Avoiding Cardio for Recovery Week
```javascript
// Temporary preference (time-limited override)
{
  description: "Deload week - no cardio",
  recommendations_guidance: "Avoid all cardio exercises, keep intensity low",
  expire_time: "2024-11-03T00:00:00Z",  // Expires in 7 days
  delete_after_call: false
}

// Result: AI won't recommend cardio until 2024-11-03
// Preference automatically becomes inactive after expiration
```

### Scenario 4: Combined Preferences
```javascript
// User has both types
permanent: [
  {
    description: "No olympic lifts",
    recommendations_guidance: "Avoid snatches, clean & jerk, and power cleans",
    expire_time: null,
    delete_after_call: false
  }
]

temporary: [
  {
    description: "Focus on chest today",
    recommendations_guidance: "All exercises should target chest muscles",
    expire_time: null,
    delete_after_call: true
  }
]

// Result: AI recommends chest exercises only (temporary override)
//         AND still avoids olympic lifts (permanent restriction)
// Both preferences are respected, with temporary taking priority for focus
```

## Benefits of This Approach

1. **Clear Separation**: Temporary vs permanent is determined by data, not a type field
2. **Flexible**: Users can have time-limited preferences without manual deletion
3. **Self-Cleaning**: Temporary preferences with delete_after_call are automatically removed
4. **Intuitive**: Expiration time naturally indicates temporary nature
5. **Override Logic**: Clear hierarchy prevents conflicting instructions to AI

